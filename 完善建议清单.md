# 餐厅积分抽奖系统 - 后端完善建议清单

> **基于深度代码分析的全面完善方案**

## 🚨 一、紧急修复（1-3天）

### 1.1 恢复缺失功能
- [ ] **创建数据库初始化脚本** `scripts/init-db.js`
- [ ] **创建数据库测试脚本** `scripts/test-db.js`  
- [ ] **创建API测试脚本** `scripts/test-apis.js`
- [ ] **启用拍照上传路由** 取消 `app.js` 中的注释
- [ ] **启用商家管理路由** 取消 `app.js` 中的注释

### 1.2 安全风险修复
- [ ] **强制生产环境JWT密钥检查**
- [ ] **加强输入验证**（使用joi或express-validator）
- [ ] **SQL注入防护检查**
- [ ] **敏感数据日志过滤**

### 1.3 Sealos对象存储配置 ✅ 已完成
- [x] **配置真实Sealos参数** 已使用用户提供的配置
  - 桶名：tiangong
  - Access Key：br0za7uc
  - Secret Key：skxg8mk5gqfhf9xz
  - 内网端点：object-storage.objectstorage-system.svc.cluster.local
  - 外网端点：objectstorageapi.bja.sealos.run
- [x] **创建Sealos存储服务** `services/sealosStorage.js`
- [x] **创建存储连接测试** `test-sealos.js`
- [x] **更新环境变量配置** `config.example`
- [x] **添加AWS SDK依赖** `package.json`

---

## ⚡ 二、高优先级完善（1-2周）

### 2.1 核心功能实现

#### 📸 拍照上传系统完整实现 🔄 进行中
```javascript
// 📁 创建 routes/photo.js
// 🔴 实现功能：
// ✅ 图片上传到Sealos对象存储（已完成配置）
// ✅ OCR识别集成（百度/腾讯/阿里云）
// ✅ 自动积分计算和奖励
// ✅ 审核工作流
// ✅ WebSocket审核结果推送
```

#### 👨‍💼 商家管理系统完整实现  
```javascript
// 📁 创建 routes/merchant.js
// 🔴 实现功能：
// ✅ 商家权限申请API
// ✅ 拍照审核管理API
// ✅ 批量审核功能
// ✅ 审核统计数据API
// ✅ 商家权限验证中间件
```

#### 🗄️ 数据库优化
```sql
-- 🔴 需要优化：
-- ✅ 创建缺失的辅助表（merchant_applications等）
-- ✅ 添加复合索引优化查询性能
-- ✅ 创建统计视图加速报表查询
-- ✅ 实现存储过程保证事务原子性
-- ✅ 设置数据清理策略
```

### 2.2 架构完善

#### 统一错误处理
```javascript
// 📁 middleware/errorHandler.js
const errorHandler = (err, req, res, next) => {
  const errorCode = err.code || 1000;
  const errorMessage = err.message || '系统异常';
  
  // 记录错误日志
  logger.error('API Error:', {
    error: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    userAgent: req.headers['user-agent'],
    userId: req.user?.user_id
  });
  
  res.json({
    code: errorCode,
    msg: errorMessage,
    data: null
  });
};
```

#### 业务逻辑分离
```javascript
// 📁 services/lotteryService.js
class LotteryService {
  // 抽奖算法核心逻辑
  static async performDraw(userId, drawType) {
    // 复杂的抽奖逻辑实现
  }
  
  static async calculateProbability(prizes) {
    // 概率计算逻辑
  }
}

// 📁 services/pointsService.js  
class PointsService {
  // 积分计算和操作逻辑
  static async updateUserPoints(userId, points, reason, transaction) {
    // 原子性积分操作
  }
}
```

### 2.3 缓存系统实现

#### Redis缓存策略
```javascript
// 📁 services/cacheService.js
class CacheService {
  // 用户信息缓存（30分钟）
  static async getUserInfo(userId) {
    const cacheKey = `user:${userId}`;
    let userInfo = await redis.get(cacheKey);
    
    if (!userInfo) {
      userInfo = await User.findByPk(userId);
      await redis.setex(cacheKey, 1800, JSON.stringify(userInfo));
    }
    
    return userInfo;
  }
  
  // 抽奖配置缓存（1小时）
  static async getLotteryConfig() {
    const cacheKey = 'lottery:config';
    let config = await redis.get(cacheKey);
    
    if (!config) {
      config = await LotterySetting.getFrontendConfig();
      await redis.setex(cacheKey, 3600, JSON.stringify(config));
    }
    
    return config;
  }
  
  // 商品列表缓存（5分钟）
  static async getProductList(filters) {
    const cacheKey = `products:${JSON.stringify(filters)}`;
    let products = await redis.get(cacheKey);
    
    if (!products) {
      products = await CommodityPool.getProductsForFrontend(filters);
      await redis.setex(cacheKey, 300, JSON.stringify(products));
    }
    
    return products;
  }
}
```

---

## 🔧 三、中优先级完善（2-4周）

### 3.1 监控系统建设

#### 健康检查接口
```javascript
// 📁 routes/health.js
router.get('/health', async (req, res) => {
  const healthStatus = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    environment: process.env.NODE_ENV,
    checks: {
      database: await checkDatabaseConnection(),
      redis: await checkRedisConnection(),
      disk: await checkDiskSpace(),
      websocket: await checkWebSocketService()
    }
  };
  
  const overallStatus = Object.values(healthStatus.checks).every(check => check.status === 'ok');
  res.status(overallStatus ? 200 : 503).json(healthStatus);
});

// 详细健康检查
router.get('/health/detailed', async (req, res) => {
  const detailedHealth = {
    ...basicHealth,
    database: {
      connectionPool: await getDatabasePoolStatus(),
      slowQueries: await getSlowQueryCount(),
      tableStatus: await getTableStatusInfo()
    },
    business: {
      activeUsers: await getActiveUserCount(),
      pendingReviews: await getPendingReviewCount(),
      systemLoad: await getSystemLoadInfo()
    }
  };
  
  res.json(detailedHealth);
});
```

#### 性能监控中间件
```javascript
// 📁 middleware/performanceMonitor.js
const performanceMonitor = (req, res, next) => {
  const startTime = Date.now();
  
  res.on('finish', () => {
    const endTime = Date.now();
    const responseTime = endTime - startTime;
    
    // 记录性能指标
    logger.info('API Performance:', {
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      responseTime: `${responseTime}ms`,
      userAgent: req.headers['user-agent'],
      userId: req.user?.user_id
    });
    
    // 慢查询预警
    if (responseTime > 1000) {
      logger.warn('Slow API Response:', {
        url: req.url,
        responseTime: `${responseTime}ms`
      });
    }
  });
  
  next();
};
```

### 3.2 日志系统完善

#### 结构化日志
```javascript
// 📁 config/logger.js
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json(),
    winston.format.prettyPrint()
  ),
  defaultMeta: { service: 'restaurant-points-api' },
  transports: [
    // 错误日志
    new winston.transports.File({ 
      filename: 'logs/error.log', 
      level: 'error',
      maxsize: 10485760, // 10MB
      maxFiles: 5
    }),
    
    // 应用日志
    new winston.transports.File({ 
      filename: 'logs/app.log',
      maxsize: 10485760,
      maxFiles: 10 
    }),
    
    // 业务日志
    new winston.transports.File({
      filename: 'logs/business.log',
      level: 'info',
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json()
      )
    })
  ]
});

// 开发环境控制台输出
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}

module.exports = logger;
```

#### 业务日志记录
```javascript
// 📁 utils/businessLogger.js
class BusinessLogger {
  // 用户操作日志
  static logUserAction(userId, action, details = {}) {
    logger.info('User Action:', {
      userId,
      action,
      details,
      timestamp: new Date().toISOString()
    });
  }
  
  // 抽奖记录日志
  static logLotteryDraw(userId, drawType, results, pointsCost) {
    logger.info('Lottery Draw:', {
      userId,
      drawType,
      results: results.length,
      pointsCost,
      timestamp: new Date().toISOString()
    });
  }
  
  // 商品兑换日志
  static logExchange(userId, productId, quantity, pointsCost) {
    logger.info('Product Exchange:', {
      userId,
      productId,
      quantity,
      pointsCost,
      timestamp: new Date().toISOString()
    });
  }
  
  // 审核操作日志
  static logReview(reviewerId, uploadId, action, reason) {
    logger.info('Photo Review:', {
      reviewerId,
      uploadId,
      action,
      reason,
      timestamp: new Date().toISOString()
    });
  }
}
```

### 3.3 安全机制加强

#### JWT增强安全
```javascript
// 📁 middleware/enhancedAuth.js
class EnhancedAuth {
  // JWT密钥强度验证
  static validateJWTSecret() {
    const secret = process.env.JWT_SECRET;
    
    if (!secret || secret === 'your_jwt_secret_key_change_in_production') {
      throw new Error('🔴 生产环境必须设置强JWT密钥');
    }
    
    if (secret.length < 32) {
      throw new Error('🔴 JWT密钥长度至少32个字符');
    }
  }
  
  // Token黑名单机制
  static async addToBlacklist(token) {
    const decoded = jwt.decode(token);
    const ttl = decoded.exp - Math.floor(Date.now() / 1000);
    await redis.setex(`blacklist:${token}`, ttl, '1');
  }
  
  static async isBlacklisted(token) {
    return await redis.exists(`blacklist:${token}`);
  }
  
  // 设备指纹验证
  static generateDeviceFingerprint(req) {
    const ua = req.headers['user-agent'];
    const ip = req.ip;
    const acceptLanguage = req.headers['accept-language'];
    
    return crypto.createHash('sha256')
      .update(`${ua}${ip}${acceptLanguage}`)
      .digest('hex');
  }
}
```

#### 输入验证增强
```javascript
// 📁 middleware/validation.js
const Joi = require('joi');

const validationSchemas = {
  // 用户登录验证
  login: Joi.object({
    phone: Joi.string().pattern(/^1[3-9]\d{9}$/).required(),
    code: Joi.string().length(6).pattern(/^\d+$/).required()
  }),
  
  // 抽奖请求验证
  lotteryDraw: Joi.object({
    draw_type: Joi.string().valid('single', 'triple', 'quintuple', 'decade').required(),
    count: Joi.number().integer().min(1).max(10).required()
  }),
  
  // 商品兑换验证
  exchange: Joi.object({
    commodity_id: Joi.number().integer().positive().required(),
    quantity: Joi.number().integer().min(1).max(10).required(),
    delivery_info: Joi.object({
      name: Joi.string().min(2).max(20).required(),
      phone: Joi.string().pattern(/^1[3-9]\d{9}$/).required(),
      address: Joi.string().min(10).max(200).required()
    }).required()
  }),
  
  // 图片上传验证
  photoUpload: Joi.object({
    amount: Joi.number().precision(2).min(0.01).max(10000).required()
  })
};

const validateInput = (schema) => {
  return (req, res, next) => {
    const { error, value } = schema.validate(req.body);
    
    if (error) {
      return res.json({
        code: 1001,
        msg: `参数验证失败: ${error.details[0].message}`,
        data: null
      });
    }
    
    req.validatedBody = value;
    next();
  };
};

module.exports = { validationSchemas, validateInput };
```

---

## 🧪 四、测试系统建设（1-2周）

### 4.1 单元测试
```javascript
// 📁 tests/unit/services/lotteryService.test.js
const LotteryService = require('../../../services/lotteryService');

describe('LotteryService', () => {
  describe('performDraw', () => {
    test('应该根据概率正确返回奖品', async () => {
      const result = await LotteryService.performDraw(1, 'single');
      expect(result).toHaveProperty('prize_id');
      expect(result).toHaveProperty('angle');
    });
    
    test('应该处理无效用户ID', async () => {
      await expect(LotteryService.performDraw(null, 'single'))
        .rejects.toThrow('用户ID不能为空');
    });
  });
});

// 📁 tests/unit/models/user.test.js  
const User = require('../../../models/User');

describe('User Model', () => {
  test('应该正确脱敏手机号', () => {
    const user = new User({ mobile: '13800138000' });
    expect(user.getMaskedMobile()).toBe('138****8000');
  });
  
  test('应该返回安全的用户信息', () => {
    const user = new User({
      user_id: 1,
      mobile: '13800138000',
      total_points: 1000
    });
    
    const safeInfo = user.getSafeUserInfo();
    expect(safeInfo).not.toHaveProperty('password');
    expect(safeInfo.mobile).toBe('138****8000');
  });
});
```

### 4.2 集成测试
```javascript
// 📁 tests/integration/auth.test.js
const request = require('supertest');
const app = require('../../app');

describe('Authentication API', () => {
  test('POST /api/auth/login - 成功登录', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        phone: '13800138000',
        code: '123456'
      });
      
    expect(response.status).toBe(200);
    expect(response.body.code).toBe(0);
    expect(response.body.data).toHaveProperty('access_token');
  });
  
  test('POST /api/auth/login - 手机号格式错误', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        phone: '138001380',
        code: '123456'
      });
      
    expect(response.body.code).toBe(1001);
  });
});
```

### 4.3 API自动化测试脚本
```javascript
// 📁 scripts/test-apis.js
const axios = require('axios');

class APITester {
  constructor(baseURL) {
    this.baseURL = baseURL;
    this.token = null;
  }
  
  async runAllTests() {
    console.log('🧪 开始API自动化测试...');
    
    try {
      await this.testAuth();
      await this.testLottery();
      await this.testExchange();
      await this.testUser();
      
      console.log('✅ 所有测试通过');
    } catch (error) {
      console.error('❌ 测试失败:', error.message);
      process.exit(1);
    }
  }
  
  async testAuth() {
    console.log('测试认证功能...');
    
    // 测试登录
    const loginRes = await axios.post(`${this.baseURL}/api/auth/login`, {
      phone: '13800138000',
      code: '123456'
    });
    
    if (loginRes.data.code !== 0) {
      throw new Error('登录测试失败');
    }
    
    this.token = loginRes.data.data.access_token;
    console.log('✅ 认证测试通过');
  }
  
  async testLottery() {
    console.log('测试抽奖功能...');
    
    // 测试获取配置
    const configRes = await axios.get(`${this.baseURL}/api/lottery/config`, {
      headers: { Authorization: `Bearer ${this.token}` }
    });
    
    if (configRes.data.code !== 0) {
      throw new Error('抽奖配置测试失败');
    }
    
    console.log('✅ 抽奖测试通过');
  }
}

// 运行测试
const tester = new APITester('http://localhost:3000');
tester.runAllTests();
```

---

## 🚀 五、部署和运维优化（1周）

### 5.1 Docker优化
```dockerfile
# 📁 Dockerfile.optimized
# 多阶段构建减小镜像大小
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

FROM node:18-alpine AS runtime

# 创建非root用户
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodeuser -u 1001

WORKDIR /app

# 复制依赖和代码
COPY --from=builder /app/node_modules ./node_modules
COPY --chown=nodeuser:nodejs . .

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD node healthcheck.js

# 切换到非root用户
USER nodeuser

EXPOSE 3000 8080

CMD ["node", "app.js"]
```

### 5.2 环境变量验证
```javascript
// 📁 config/envValidator.js
const requiredEnvVars = {
  development: ['DB_HOST', 'DB_USER', 'DB_PASSWORD', 'JWT_SECRET'],
  production: [
    'DB_HOST', 'DB_USER', 'DB_PASSWORD', 'DB_NAME',
    'JWT_SECRET', 'JWT_REFRESH_SECRET', 'ENCRYPTION_KEY',
    'REDIS_HOST', 'SEALOS_ACCESS_KEY', 'SEALOS_SECRET_KEY'
  ]
};

function validateEnvironment() {
  const env = process.env.NODE_ENV || 'development';
  const required = requiredEnvVars[env] || requiredEnvVars.development;
  
  const missing = required.filter(varName => !process.env[varName]);
  
  if (missing.length > 0) {
    console.error('🔴 缺少必需的环境变量:', missing.join(', '));
    process.exit(1);
  }
  
  // 验证JWT密钥强度
  if (env === 'production') {
    const jwtSecret = process.env.JWT_SECRET;
    if (jwtSecret.length < 32) {
      console.error('🔴 生产环境JWT密钥长度至少32个字符');
      process.exit(1);
    }
  }
  
  console.log('✅ 环境变量验证通过');
}

module.exports = { validateEnvironment };
```

### 5.3 CI/CD流水线
```yaml
# 📁 .github/workflows/deploy.yml
name: Deploy Restaurant Points Backend

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: test_db
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Run tests
      run: npm test
      env:
        DB_HOST: localhost
        DB_USER: root
        DB_PASSWORD: testpass
        DB_NAME: test_db
        JWT_SECRET: test_jwt_secret_for_testing_only
    
    - name: Run security audit
      run: npm audit --audit-level moderate
  
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: |
        docker build -t restaurant-points-backend:${{ github.sha }} .
        docker tag restaurant-points-backend:${{ github.sha }} restaurant-points-backend:latest
    
    - name: Deploy to staging
      run: |
        # 部署到测试环境
        echo "部署到测试环境"
    
    - name: Health check
      run: |
        # 健康检查
        curl -f http://staging-api/health || exit 1
```

---

## 📊 六、监控告警系统（1周）

### 6.1 业务监控指标
```javascript
// 📁 services/metricsService.js
class MetricsService {
  // 抽奖业务指标
  static async recordLotteryMetrics(userId, drawType, result) {
    await Promise.all([
      // 抽奖次数统计
      redis.incr('metrics:lottery:total'),
      redis.incr(`metrics:lottery:${drawType}`),
      
      // 中奖率统计
      result.is_winning && redis.incr('metrics:lottery:winning'),
      
      // 用户抽奖统计
      redis.incr(`metrics:user:${userId}:lottery`)
    ]);
  }
  
  // 兑换业务指标
  static async recordExchangeMetrics(userId, productId, pointsCost) {
    await Promise.all([
      // 兑换次数统计
      redis.incr('metrics:exchange:total'),
      redis.incr(`metrics:product:${productId}:exchange`),
      
      // 积分消费统计
      redis.incrby('metrics:points:consumed', pointsCost),
      
      // 用户兑换统计
      redis.incr(`metrics:user:${userId}:exchange`)
    ]);
  }
  
  // 获取实时业务指标
  static async getBusinessMetrics() {
    const [
      totalLottery,
      totalExchange,
      totalPointsConsumed,
      winningCount
    ] = await Promise.all([
      redis.get('metrics:lottery:total'),
      redis.get('metrics:exchange:total'),
      redis.get('metrics:points:consumed'),
      redis.get('metrics:lottery:winning')
    ]);
    
    return {
      lottery: {
        total: parseInt(totalLottery) || 0,
        winning: parseInt(winningCount) || 0,
        winningRate: totalLottery ? (winningCount / totalLottery * 100).toFixed(2) : 0
      },
      exchange: {
        total: parseInt(totalExchange) || 0,
        pointsConsumed: parseInt(totalPointsConsumed) || 0,
        averagePointsPerExchange: totalExchange ? 
          Math.round(totalPointsConsumed / totalExchange) : 0
      }
    };
  }
}
```

### 6.2 告警系统
```javascript
// 📁 services/alertService.js
class AlertService {
  // 错误率告警
  static async checkErrorRate() {
    const errorCount = await redis.get('metrics:errors:count') || 0;
    const totalRequests = await redis.get('metrics:requests:total') || 0;
    
    if (totalRequests > 100) {
      const errorRate = errorCount / totalRequests;
      if (errorRate > 0.05) { // 错误率超过5%
        await this.sendAlert('ERROR_RATE_HIGH', {
          errorRate: (errorRate * 100).toFixed(2),
          errorCount,
          totalRequests
        });
      }
    }
  }
  
  // 响应时间告警
  static async checkResponseTime() {
    const avgResponseTime = await redis.get('metrics:response_time:avg') || 0;
    
    if (avgResponseTime > 1000) { // 平均响应时间超过1秒
      await this.sendAlert('RESPONSE_TIME_HIGH', {
        avgResponseTime: `${avgResponseTime}ms`
      });
    }
  }
  
  // 数据库连接告警
  static async checkDatabaseHealth() {
    try {
      await sequelize.authenticate();
    } catch (error) {
      await this.sendAlert('DATABASE_CONNECTION_FAILED', {
        error: error.message
      });
    }
  }
  
  // 发送告警
  static async sendAlert(type, data) {
    const alert = {
      type,
      data,
      timestamp: new Date().toISOString(),
      severity: this.getAlertSeverity(type)
    };
    
    // 记录告警日志
    logger.error('System Alert:', alert);
    
    // 发送到告警系统（如钉钉、企业微信等）
    if (process.env.WEBHOOK_URL) {
      await this.sendWebhookAlert(alert);
    }
  }
  
  static getAlertSeverity(type) {
    const severityMap = {
      'ERROR_RATE_HIGH': 'high',
      'RESPONSE_TIME_HIGH': 'medium',
      'DATABASE_CONNECTION_FAILED': 'critical'
    };
    return severityMap[type] || 'low';
  }
}
```

---

## 📋 七、实施计划建议

### 第一周：紧急修复
- [ ] 恢复数据库初始化脚本
- [ ] 启用拍照上传和商家管理路由
- [ ] 加强输入验证和安全检查
- [ ] 实现基础错误处理

### 第二周：核心功能
- [ ] 完整实现拍照上传系统
- [ ] 完整实现商家管理系统  
- [ ] 集成真实的OCR服务
- [ ] 实现Sealos对象存储

### 第三周：架构优化
- [ ] 实现Redis缓存系统
- [ ] 重构业务逻辑分离
- [ ] 建设监控和日志系统
- [ ] 创建健康检查接口

### 第四周：测试和部署
- [ ] 建设自动化测试
- [ ] 优化Docker配置
- [ ] 建设CI/CD流水线
- [ ] 性能测试和优化

---

## 🎯 八、成功指标

### 技术指标
- [ ] API平均响应时间 < 200ms
- [ ] 错误率 < 1%
- [ ] 数据库查询时间 < 50ms
- [ ] WebSocket连接成功率 > 99%
- [ ] 系统可用性 > 99.9%

### 业务指标  
- [ ] 用户注册转化率 > 80%
- [ ] 抽奖功能使用率 > 60%
- [ ] 商品兑换成功率 > 95%
- [ ] 拍照审核处理时间 < 2小时
- [ ] 用户投诉率 < 0.1%

### 开发效率指标
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖率 > 70%
- [ ] 代码审查通过率 > 95%
- [ ] 部署成功率 > 99%
- [ ] 回滚时间 < 5分钟

---

> **🚀 总结**: 通过以上完善措施，可以将餐厅积分抽奖系统从当前的基础实现提升为生产级别的高质量系统，具备完整的功能、可靠的性能、强大的安全性和良好的可维护性。建议按照优先级分阶段实施，确保系统稳定运行的同时逐步完善各项功能。 